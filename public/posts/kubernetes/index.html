<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.59.1" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="//fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/skeleton.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="tsujimitsu.tsuji.dev">
<title> - tsujimitsu.tsuji.dev</title>
</head>
<body>

<div class="container">

	<header role="banner">
		<div class="header-logo">
			<a href="/"><img src="" width="60" height="60" alt="tsujimitsu.tsuji.dev"></a>
		</div>
		
	</header>


	<main role="main">
		<article itemscope itemtype="http://schema.org/BlogPosting">
			<h1 class="entry-title" itemprop="headline"></h1>
			<span class="entry-meta"><time itemprop="datePublished" datetime="0001-01-01">January 01, 0001</time></span>
			<section itemprop="entry-text">
				

<p><a href="https://store.docker.com/editions/community/docker-ce-desktop-mac">https://store.docker.com/editions/community/docker-ce-desktop-mac</a>
Get Docker CE for Mac (Edge)</p>

<p>Preference &gt; Kubernetes
  Enable Kubernetes</p>

<h2 id="入門-kubernetes">入門 Kubernetes</h2>

<ul>
<li><p>可用性を保ちながら素早くリリースをし続けるために必要なもの</p>

<ul>
<li>immutability（イミュータブル）</li>
<li>一度リリースした物件には変更を加えない。変更する場合は別のリリース物件として出す</li>
<li>apt-getでパッケージをアップデートしてシステムを最新化していくやり方はミュータブル</li>
<li>declarative configuration（宣言的設定）</li>
<li>あるべき状態を定義する。システムがその状態を維持するように動く</li>
<li>宣言的設定の反対は命令的設定</li>
<li>online self-healing system（自己回復するシステム）</li>
<li>絶えず「宣言的設定」で定義された状態であり続けられるように動く
<br /></li>
</ul></li>

<li><p>コンテナの利点</p>

<ul>
<li>依存性の管理</li>
<li>カプセル化</li>
</ul></li>

<li><p>kubectlバージョン</p>

<ul>
<li>kubenertesのツールはマイナーバージョン２つまではkubernetes APIのバージョンと後方互換性、前方互換性がある</li>
</ul></li>

<li><p>Pod</p>

<ul>
<li>Pod内のコンテナは同一サーバ上で起動する</li>
<li>Podは同一IPとポートを持つ</li>

<li><p>Podのデプロイ情報はPodマニフェストに記述する.通常は読みやすくコメント付与できるYAML形式で作成する</p>

<pre><code>$ cat kuard-pod.yaml
apiVersion: v1
kind: Pod
metadata:
name: kuard
spec:
containers:
- image: gcr.io/kuar-demo/kuard-amd64:1
name: kuard
ports:
- containerPort: 8080
name: http
protocol: TCP
</code></pre>

<pre><code>※以下のコマンドはほぼ同義
$ docker run -d --name kuard --publish 8080:8080 gcr.io/kuar-demo/kuard-amd64:1
$ kubectl apply -f kuard-pod.yaml
</code></pre></li>
</ul></li>

<li><p>port-forward</p>

<ul>
<li><p>ポートフォワードコマンド実行中はローカルマシンからPodにアクセスできる</p>

<pre><code>$ kubectl port-forward kuard 8080:8080
</code></pre></li>
</ul></li>

<li><p>ログ情報の取得</p>

<pre><code>$ kubectl logs kuard
$ kubectl logs -f kuard
</code></pre></li>

<li><p>コンテナ上でコマンド実行</p>

<pre><code>$ kubectl exec kuard date
$ kubectl exec -it kuard ash
</code></pre></li>

<li><p>コンテナ上のファイルをローカルにコピー、その逆</p>

<ul>
<li>コンテナ上にファイルをコピーする行為はアンチパターン</li>

<li><p>障害時の緊急対応といったやむおえない場合にとどめておく</p>

<pre><code>$ kubectl cp kuard:/etc/hostname ./
$ kubectl cp $HOME/config.txt kuard:/config.txt
</code></pre></li>
</ul></li>

<li><p>Liveness probe</p>

<ul>
<li>プロセス監視によるヘルスチェックだけでなくAPレベルでチェックする方法</li>
<li>Podマニフェストにliveness probeの定義を書く</li>

<li><p>httpだけでなくtcpSocket, exec監視も可能</p>

<pre><code>...
spec:
containers:
- image: grc.io/kuar-demo/kuard-amd64:1
name: kuard
livenessProbe:
httpGet:
  path: /healthy
  port: 8080
initialDelaySeconds: 5
timeoutSeconds: 1
periodSeconds: 10
failureThreshold: 3
...
</code></pre></li>
</ul></li>

<li><p>Readiness probe</p>

<ul>
<li>コンテナがユーザからのリクエストを処理できるか</li>
</ul></li>

<li><p>リソース要求とリソース使用量の制限</p>

<ul>
<li>コンテナ毎にリソース最低使用量と最大使用制限が設定できる</li>
<li>要求：requests を設定すると最低限必要なリソースを確保してくれる</li>
<li>制限：limits を設定すると最大限利用できるリソースの制限ができる</li>
</ul></li>

<li><p>永続的なディスク(PersistentVolume)</p>

<ul>
<li>VolumeリソースをPodマニフェストで使う</li>
<li>spec.Volumesセクションとコンテナ定義内のvolumeMountsにそれぞれ記述する</li>
<li>ホストのディレクトリマウント、NFSやiSCSI,クラウドプロバイダのネットワークストレージを使う方法がある</li>
<li>通常はどのホスト上でもデータを引き継ぎたいのでホストディレクトリのマウントは行わない</li>
</ul></li>

<li><p>Context</p>

<ul>
<li>デフォルトでは &ldquo;default&rdquo; Namespace が Context として設定されている</li>
<li>接続先 Context を変更する場合は以下のコマンドを使う</li>

<li><p>Context は異なるクラスタを管理する &ndash;cluster フラグやクラスタ認証ユーザを指定する &ndash;user フラグも使用できる</p>

<pre><code>$ kubectl config get-contexts
$ kubectl config set-context &lt;contextname&gt; --namespae=&lt;namespacename&gt;
$ kubectl config use-context &lt;contextname&gt;
</code></pre></li>
</ul></li>

<li><p>CLI オプション</p>

<ul>
<li>-o wide</li>
<li>情報を多く表示</li>
<li>-o json/yaml</li>
<li>表示形式変更</li>
<li>-o jsonpath &ndash;template=&lsquo;{XXX}&rsquo;</li>
<li>JSONPathで抜き出し</li>
<li>&ndash;no-headers</li>
<li>ヘッダを表示しない</li>
</ul></li>

<li><p>サービスディスカバリ</p>

<ul>
<li>Serviceオブジェクトを使う</li>
<li>ClusterIPを作成し、Serviceに紐づくPodに対してロードバランシングを実現する</li>
</ul></li>
</ul>

<h2 id="コマンド">コマンド</h2>

<ul>
<li><p>クラスタのステータス確認</p>

<pre><code>$ kubectl get componentstatus
$ kubectl get nodes
$ kubectl describe nodes &lt;nodename&gt;
$ kubectl config get-contexts
</code></pre></li>

<li><p>オブジェクトの編集</p>

<pre><code>$ kubectl edit &lt;ResourceName&gt; &lt;ObjectName&gt;
</code></pre></li>

<li><p>Pod作成</p>

<pre><code>$ kubectl run kuard --image=gcr.io/kuar-demo/kuard-amd64:1
</code></pre></li>

<li><p>Dashboardデプロイ</p>

<pre><code>$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml
$ kubectl proxy
$ curl http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/
-&gt; Token
</code></pre></li>
</ul>

<h2 id="不要コンテナを削除">不要コンテナを削除</h2>

<ul>
<li><p>docker-gc</p>

<ul>
<li>kubernetesではDeamonSetで全ホスト場で実行する</li>

<li><p><a href="https://github.com/kubernetes/charts/tree/master/stable/spotify-docker-gc">https://github.com/kubernetes/charts/tree/master/stable/spotify-docker-gc</a></p>

<pre><code>docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /etc:/etc:ro spotify/docker-gc
</code></pre></li>
</ul></li>
</ul>

<h2 id="疑問">疑問</h2>

<ul>
<li>kubectl describeのConditionsに表示されるOutOfDisk, MemoryPressure, DiskPressureの意味

<ul>
<li>Falseであれば問題ない。ex. OutOfDiskになっていないかどうか。Falseならなっていない</li>
</ul></li>
<li>kubectl get のステータス表示の意味</li>
</ul>

			</section>
		</article>
	</main>


	<footer role="contentinfo">
		<div class="hr"></div>
		<div class="footer-link">
			
			<a href="https://twitter.com/tsujimitsu" target="_blank">Twitter</a>
			<a href="https://www.facebook.com/tsujimitsu" target="_blank">Facebook</a>
			<a href="https://github.com/tsujimitsu/" target="_blank">GitHub</a>
			
		</div>
		<div class="copyright">Copyright &copy; </div>
	</footer>

</div>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-152694591-1', 'auto');
	ga('send', 'pageview');
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>
