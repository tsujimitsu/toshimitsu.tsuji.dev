<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.59.1" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="//fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/skeleton.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="tsujimitsu.tsuji.dev">
<title>HTTPS for AWS ELB(Elastic Load Balancer) - tsujimitsu.tsuji.dev</title>
</head>
<body>

<div class="container">

	<header role="banner">
		<div class="header-logo">
			<a href="/"><img src="" width="60" height="60" alt="tsujimitsu.tsuji.dev"></a>
		</div>
		
	</header>


	<main role="main">
		<article itemscope itemtype="http://schema.org/BlogPosting">
			<h1 class="entry-title" itemprop="headline">HTTPS for AWS ELB(Elastic Load Balancer)</h1>
			<span class="entry-meta"><time itemprop="datePublished" datetime="2014-12-11">December 11, 2014</time></span>
			<section itemprop="entry-text">
				

<h1 id="introduction">Introduction</h1>

<ul>
<li>本記事は<a href="http://www.adventar.org/calendars/574">HZ Colloquium Advent Calendar</a> 2014の12/11分の記事です。</li>
<li>前回記事（<a href="http://www.codelogue.com/articles/nodejs/nodejs-welcome-to-webapi-world.html">Welcome to WebAPI World</a>）の続きとなります。</li>
</ul>

<h1 id="前回までのあらすじ">前回までのあらすじ</h1>

<p>WebAPIを作ってみたくて色々調べてみたよってところまでは話した。が、実装まではたどりつけませんでした。
せっかくのWebAPIだからロードバランサで可用性担保しつつ、SSLなセキュアAPIを実現！という夢を語りました。</p>

<h1 id="本日のお話">本日のお話</h1>

<p>「せっかく」のところを実現してみました。ロードバランサとSSL通信のことです。
具体的にはAWSのロードバランササービス「ELB(Elastic Load Balancer)」の設定と
クライアントからのHTTPS通信でのアクセスの実現です。結構ウェブ上に情報はあったので
それほど苦労もなく実現できてしまいました。
なお、下記サイトに書いてあることとほぼ同じことをやった感じ。
全て網羅されてまとめられていて大変感謝です。
* <a href="http://qiita.com/kntmrkm/items/19112e500b91441f276e">AWSのELBにSSLを設定する（Nginx）</a></p>

<h1 id="おしながき">おしながき</h1>

<ol>
<li>PayPalへの登録（おまけ）</li>
<li>SSL証明書の購入手続き</li>
<li>ELBの設定（SSL証明書の導入）</li>
<li>ドメインとELBの紐づけ</li>
</ol>

<h1 id="paypalへの登録">PayPalへの登録</h1>

<p>SSL証明書の購入に必要だった＋初体験ってこともあったので登録してみました。
完璧には仕組みがわかってなかったんですけども、簡単に使えてます。
サービス利点としては、各ネット店舗での購入の際に毎回クレジットカード番号を
入れないといけないのを、一度PayPalにクレジット情報を登録しておけば、
PayPalとネット店舗間でお金のやり取りをやってくれるってところ。
初め理解ができなかったのは、上記以外にも「送金」ができるってところ。
日本の中では銀行以外が送金業務できないので実質は初めに行ったサービスだけ
使えるんだけど、法改正とかあるらしくて近く「送金」できるようになるみたい。
まぁネット上の銀行口座にクレジットから振り込みできるってことかな。
ちなみに、登録にはほぼ迷うことなく完了。</p>

<h1 id="ssl証明書の購入手続き">SSL証明書の購入手続き</h1>

<h2 id="メールアドレスの準備">メールアドレスの準備</h2>

<p>SSL証明書を購入する際は、正しいドメインの所有者か確認するため（？）に
ドメイン名のメールアドレスにメールが送られてくる。
admin@codelogue.com とかを用意する（SSL証明書購入時に
いくつか選択肢がでてくるので、それを確認してから作成でもよい）
なお、独自ドメインで無料メールアドレスを持とうとすると、意外と狭き道だった。
（運よく昔作ったGoogle Appsのアカウントが有効だったため助かった）</p>

<h2 id="csrの作成">CSRの作成</h2>

<p>AWSのELBに証明書を登録するためにはパスフレーズなしにする必要がある。</p>

<pre><code class="language-sh"># 秘密鍵の作成（パスフレーズは適当に）
openssl genrsa -des3 -out aws-elb.key.pem 2048

# 秘密鍵からパスフレーズを削除
openssl rsa -in aws-elb.key.pem -out aws-elb.key_np.pem

# ディスティングイッシュネーム情報の登録
openssl req -new -key aws-elb.key_np.pem -out aws-elb.csr.pem
&gt; JP
&gt; Chiba
&gt; Nantara-shi
&gt; codelogue
&gt; system
&gt; api.codelogue.com

# 確認
openssl req -in aws-elb.csr.pem -text

</code></pre>

<ul>
<li><a href="http://kwstaff.tumblr.com/post/62571252341/amazon-elb-csr">Amazon ELB 用に、パスフレーズなしのCSRを作成する手順</a></li>
<li><a href="https://www.geotrust.co.jp/support/ssl/csr/apache_openssl_new.html">Apache + OpenSSL CSR生成手順 (新規)</a></li>
</ul>

<h2 id="証明書購入">証明書購入</h2>

<p><a href="http://www.ssl-store.jp/rapidssl/">Rapid SSL</a>がとにかく安いです。ssl-storeならPayPalで購入可能。1年間契約で1,150円でもてちゃうってのは凄いよね。
大手のGlobalSignとかだと1年で3,0000円以上とか。
ちなみにSSL証明書にも種類がある。簡単な分類は下記。</p>

<table>
<thead>
<tr>
<th align="left">種類</th>
<th align="left">内容</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">ドメイン認証</td>
<td align="left">暗号化通信のみ実現したいときに選択。一番安い。個人でも購入可能</td>
</tr>

<tr>
<td align="left">実在認証</td>
<td align="left">ドメインの所有者を確認する。組織が法的に存在していることを裏付ける</td>
</tr>

<tr>
<td align="left">EV</td>
<td align="left">アドレスバーが緑になるやつ。物理的に組織が存在していることを証明する。高価。1年で12万とか</td>
</tr>
</tbody>
</table>

<p>ちなみにSSL証明書にはURI固定（api.codelogue.com）のものと、ワイルドカード証明書（*.codelogue.com）の
2種類が存在し、ワイルドカードだと*の部分が可変となるため使い勝手が良い。が高い。RapidSSSLで1年1万円。
いくらワイルドカードといっても「hoge.api.codelogue.com」のようにサブドメインのサブみたいなのには対応できない。</p>

<p>ssl-storeのページで購入した後にアクティベートするときにCSRを貼り付けますけども
選択肢なにすればいいかわからなかった（ELBとかないし）
とりあえずApache opensslみたいなのを選んだけどうまくいった。</p>

<h1 id="elbの設定-ssl証明書の導入">ELBの設定（SSL証明書の導入）</h1>

<ul>
<li>ログイン後に「EC2」を選択（ELBって独自にメニューがあるわけではないのね）</li>
<li>先メニューペインからNETWORK &amp; SECURITYの項目にある「Load Balancer」を選択</li>
<li>「Create Load Balancer」を選択</li>
<li>Load Balancer nameは適当に、LB insideには振り分け先のEC2が所属するセグメントを、
Listerner Consigurationの書き方は下記参照</li>
</ul>

<table>
<thead>
<tr>
<th align="left">Load Balancer Protocol</th>
<th align="left">Load Balancer Port</th>
<th align="left">Instance Protocol</th>
<th align="left">Instance Port</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">待ち受けプロトコル（クライアントからのアクセス想定）</td>
<td align="left">待ち受けポート番号</td>
<td align="left">振り分け先プロトコル</td>
<td align="left">振り分け先ポート</td>
</tr>

<tr>
<td align="left">ex. HTTPS</td>
<td align="left">ex. 443</td>
<td align="left">ex. HTTP</td>
<td align="left">ex. 80</td>
</tr>
</tbody>
</table>

<p>上記の例のような設定をしておくことで、ELBがSSL通信を紐解き（復号化）を行い、配下のEC2へはHTTPで
通信を流すため、EC2に復号化の重い処理させずにすむ。なお、ELBがどれほどの復号性能を持っているかは知らない。
調べればでてくるかな。（SSL通信の終端（end-point）がELB）</p>

<ul>
<li>Select Certificate の欄に証明書情報を入れていく

<ul>
<li>Certificate Name: 適当</li>
<li>Private Key: 秘密鍵（さっき作ったやつ aws-elb.key.pem）</li>
<li>Public Key Certificate: 証明書（メールで送られてくる Web Server CERTIFICATE)</li>
<li>Certificate Chain: 中間証明書（メールで送られてくる INTERMEDIATE CA）</li>
</ul></li>
<li>Select a Cipher は「ELBSecurityPolicy-2014-10（今時点）」にしておく。POODLE対応でSSLv3が無効化状態になるっぽい。</li>
<li>Configure Health Checkにはヘルスチェック用のプロトコル、ポートなどを設定する。L7レベル（HTTP）やTCPレベルを選択できる。
HTTPを選択すると接続結果が200 okでない場合はELB配下から切り離す。</li>
</ul>

<h1 id="ドメインとelbの紐づけ">ドメインとELBの紐づけ</h1>

<p>なんとAWSのELBはIP直接指定ができない。最初はELBにEIP（まぁ自分持ちのIPアドレスと思ってもらえれば）を紐づけすると
思っていたけどそうではなかった。以下が大変参考になる。
* <a href="http://awsbeginner.seesaa.net/article/403004657.html">ELBへのElastic IPを割り当てる？</a>
ということで、DNS名をCNAMEで指定してあげれば完了。無事、<a href="https://api.codelogue.com/">https://api.codelogue.com/</a> でアクセスできました。
ちなみに今アクセスできないのはELBを削除しているから。だってー使わない状態でおいてても月4000円以上に
なりそうだったのでケチりました。まぁそのうちちゃんと公開します。</p>

<h1 id="参考">参考</h1>

<ul>
<li><a href="http://docs.aws.amazon.com/ja_jp/ElasticLoadBalancing/latest/DeveloperGuide/US_UpdatingLoadBalancerSSL.html">ロードバランサーの SSL 証明書の更新</a></li>
<li><a href="http://kwstaff.tumblr.com/post/62686016527/amazon-elb-ssl">誰でもできる、Amazon ELB にSSL証明書を設定する手順</a></li>
<li><a href="http://dev.classmethod.jp/cloud/aws/elb-security-update-for-tls1-1/">ELBのセキュリティアップデートによるTLS 1.1対応</a></li>
<li><a href="http://docs.aws.amazon.com/ja_jp/gettingstarted/latest/computebasics-linux/getting-started-create-lb.html">Elastic Load Balancing を作成する</a></li>
<li><a href="http://www.submit.ne.jp/1579">Amazonのロードバランサーの使い方</a></li>
<li><a href="http://mugenup-tech.hatenadiary.com/entry/2014/05/12/104009">ドメイン名を使ってEC2を運用していたら、ELBのスケールアウトで苦労した話</a></li>
<li><a href="http://tech.basicinc.jp/AWS/2013/04/28/aws_elb_customlog/">ELBを使ってアクセス元のIPを取る方法 ELBに限らないよ</a></li>
<li><a href="http://d.hatena.ne.jp/komiyak/20130807/1375845025">AWS Elastic Load Balancer と Apache を使って HTTPS(SSL) 通信を行うための設定方法</a></li>
</ul>

			</section>
		</article>
	</main>


	<footer role="contentinfo">
		<div class="hr"></div>
		<div class="footer-link">
			
			<a href="https://twitter.com/tsujimitsu" target="_blank">Twitter</a>
			<a href="https://www.facebook.com/tsujimitsu" target="_blank">Facebook</a>
			<a href="https://github.com/tsujimitsu/" target="_blank">GitHub</a>
			
		</div>
		<div class="copyright">Copyright &copy; </div>
	</footer>

</div>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-152694591-1', 'auto');
	ga('send', 'pageview');
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>
